<!DOCTYPE html>
<html>
<head>
    <title>èªè¨¼ç”¨</title>
</head>
<body>
    <div id="formDiv">
        <form action="" method="get" class="form-example" name="form">
            <div class="username" id="usernameDiv">
                <label for="name">Scratchã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯ï¼Ÿ:</label>
                <input type="text" name="name" id="name" required />
            </div>
            <div class="botan">
                <input type="button" value="ç™»éŒ²" onclick="generateID();" />
            </div>
        </form>
    </div>

    <div id="idDisplayDiv" style="display:none;">
        <p>ID: <span id="id"></span></p>
        <button id="checkButton" type="button" onclick="verifyID();">ç¢ºèª</button>
    </div>
    <div id="log">
        <p>ãƒ­ã‚°:</p>
    </div>
</body>

<script>
    function getParam(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }
    
    // **ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ç”¨ã®ãƒªã‚¹ãƒˆ**
    const encodelist = ["null", "-", "1", "2", "3", "4", "5", "6", "7", "8", "9", "0", 
                        "a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", 
                        "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z", "_"];

    // **æ–‡å­—åˆ—ã‚’ encodelist ã‚’ä½¿ã£ã¦æ•°å€¤åŒ–**
    function encodeWithEncodelist(input) {
        let encodedValues = [];
        for (let i = 0; i < input.length; i++) {
            let char = input[i].toLowerCase();
            let index = encodelist.indexOf(char);
            if (index !== -1) {
                encodedValues.push(index.toString().padStart(2, '0')); // 2æ¡ã«çµ±ä¸€
            } else {
                encodedValues.push("99"); // encodelist ã«ãªã„æ–‡å­—ã¯ "99"
            }
        }
        return encodedValues.join("");  
    }

    function log(log) {
        // idå±æ€§ã§è¦ç´ ã‚’å–å¾—
        let textbox_element = document.getElementById('log');

        // æ–°ã—ã„HTMLè¦ç´ ã‚’ä½œæˆ
        let new_element = document.createElement('p');
        new_element.textContent = log;

        // æŒ‡å®šã—ãŸè¦ç´ ã®ä¸­ã®æœ«å°¾ã«æŒ¿å…¥
        textbox_element.appendChild(new_element);

    }

    // **UUIDã‚’ç”Ÿæˆ**
    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0,
                v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    // **JWTã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰**
    function decodeTokenPayload(token) {
        try {
            return JSON.parse(atob(token.split('.')[1])); 
        } catch {
            return null;
        }
    }

    // **JWTãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯**
    function isTokenValid(token) {
        try {
            const payload = decodeTokenPayload(token);
            log(`ğŸŸ¢ payload:${JSON.stringify(payload)}`);
            if (!payload || !payload.exp) return false;

            const now = Math.floor(Date.now() / 1000);
            log(`ğŸŸ¢ now:${now}`);
            log(`ğŸŸ¢ token:${now < payload.exp}`);
            return now < payload.exp; 
        } catch {
            return false;
        }
    }

    window.onload = function() {
        let name = getParam("name");
        if (name != null) {
            log("name:" + name);
            document.getElementsByName("name")[0].value = name;
        }
    }

    // **IDç”Ÿæˆ**
    function generateID() {
        if (form.name.value == ""){
            alert("å…¥åŠ›ã—ã¦ãã ã•ã„");
            return;
        }
        scratch_username = form.name.value;
        log("ğŸ”µ generateID() å®Ÿè¡Œ");

        let UUID = generateUUID();
        let encodedUUID = encodeWithEncodelist(UUID);

        log(`ğŸŸ¢ UUID: ${UUID}`);
        log(`ğŸŸ¢ ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰UUID: ${encodedUUID}`);

        const token = localStorage.getItem("authToken");
        if (!token || !isTokenValid(token)) {
            alert("ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
            return;
        }
        let payload = decodeTokenPayload(token);

        let URL = `https://scratch.hatena-scratch.f5.si/cloud-check?username=${payload.username}&token=${token}`;
        log(`ğŸŸ¢ ç¢ºèªãƒªã‚¯ã‚¨ã‚¹ãƒˆURL:${URL}`);

        fetch(URL, { method: 'GET' })
            .then(response => response.json()) // ç›´æ¥JSONã«å¤‰æ›
            .then(data => {
                log(`ğŸŸ¢ JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${JSON.stringify(data)}`);

                if (!data.success) {
                    if (data.error.startsWith("ãƒ¦ãƒ¼ã‚¶ãƒ¼")) {
                        let result = confirm(`ç¢ºèªå¤±æ•—: ${data.error} scratchã®usernameã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`);
                        if (result) {
                            window.allowdScratch = true;
                        } else {
                            return;
                        }
                    } else {
                        alert(`ç¢ºèªå¤±æ•—: ${data.error}`);
                        return;
                    }
                } else {
                    window.allowedScratch = true;
                }

                let encodedTokenUser = encodeWithEncodelist(payload.username);
                let encodedScratchUser = encodeWithEncodelist(scratch_username);
                log(`ğŸŸ¢ ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼:${encodedTokenUser}`);
                log(`ğŸŸ¢ ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¯ãƒ©ãƒƒãƒãƒ¦ãƒ¼ã‚¶ãƒ¼:${encodedScratchUser}`);

                let ID = `${encodedUUID}00${encodedScratchUser}00${encodedTokenUser}`;
                document.getElementById("id").innerText = ID;
                document.getElementById("formDiv").style.display = "none";
                document.getElementById("idDisplayDiv").style.display = "block";

                window.generatedID = ID;
                window.generatedUsername = payload.username;
                window.generatedScratchUsername = scratch_username;

                log(`ğŸŸ¢ ç”Ÿæˆã•ã‚ŒãŸID:${ID}`);
            })
            .catch(error => {
                log(`ğŸ”´ ã‚¨ãƒ©ãƒ¼: ${error}`);
                alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
            });
    }

    // **IDã‚’ç¢ºèªã™ã‚‹**
    function verifyID() {
        log("ğŸ”µ verifyID() å®Ÿè¡Œ");

        let ID = window.generatedID;
        let username = window.generatedUsername;
        let scratch_username = window.generatedScratchUsername;
        const token = localStorage.getItem("authToken");
        const allowedScratch = window.allowedScratch;

        let URL = `https://scratch.hatena-scratch.f5.si/scratch-database?ID=${ID}&username=${username}&scratch_username=${scratch_username}&token=${token}&allowedScratch=${allowedScratch}`;
        log(`ğŸŸ¢ ç¢ºèªãƒªã‚¯ã‚¨ã‚¹ãƒˆURL:${URL}`);

        fetch(URL, { method: 'GET' })
            .then(response => {
                log(`ğŸŸ¢ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: ${response.status}`);
                return response.text();  // JSONè§£æå‰ã«ãƒ†ã‚­ã‚¹ãƒˆã§ç¢ºèª
            })
            .then(text => {
                log(`ğŸŸ¢ ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹: ${text}`);
                let data;
                try {
                    data = JSON.parse(text);  // JSONã«å¤‰æ›
                } catch (e) {
                      throw new Error("ğŸ”´ JSONã®è§£æã«å¤±æ•—");
                }
                log(`ğŸŸ¢ JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${JSON.stringify(data)}`);
                alert(data.success ? "ç¢ºèªæˆåŠŸï¼" : `ç¢ºèªå¤±æ•—: ${data.error}`);
            })
            .catch(error => {
                log(`ğŸ”´ ã‚¨ãƒ©ãƒ¼: ${error}`);
                alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
        });
    }
</script>
</html>
